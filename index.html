<!doctype html>

<html>

<head>
    <title>Tutorial 1: Getting Started</title>
    <!-- <script src="cytoscape.js" /> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.0/cytoscape.min.js"
        integrity="sha512-TOWs340KHbJjY/a2SCtsUcXYBg7/xPX72NKpJ3VITogkHJTy2yMyoJE0pxJjumMGHCg46ud89KO5q1Toe3Aeaw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.js"></script>
    <script src="cytoscape-edgehandles.js"></script>
    <link rel="stylesheet" href="index.css" />
</head>

<body>

    <input id="nodeInput" type="hidden" step="5" placeholder="Size:" max="100">
    <div id="size_scalar">
        <div>The maximum size of the node is 100</div>
        <div class="number_container">
            <div>0</div>
            <div>100</div>
        </div>
        <div class="gradient_color"></div>
    </div>
    <div id="cy"></div>
    <!-- <div class="controlContainer">
        <input type="text" name="center" id="center_node" placeholder="Please enter the node you want to CENTER">
        <button id="button_fit">Fit</button>
    </div> -->
</body>
<script type="text/javascript">
    var cy, eh, nIntervId, currentId = 0;
    var shapeIDList = [0, 0, 0, 0];
    const WIDTH = window.innerWidth, HEIGHT = window.innerHeight;
    const COLOR_PALETTES = ["#d5f4e6", "#80ced6", "#fefbd8", "#618685"];
    const SHAPE_SET = ['diamond', 'triangle', 'rectangle', 'hexagon'];
    const NODESIZE = 50;
    const COLOR_RANGE = [[210, 251, 212], [18, 63, 90]];
    const { log } = console;
    var collection, currNode;

    function initExampleNode() {
        for (let i = 0; i < 4; i++) {
            createNewShapeNode(i, NODESIZE / 2, i * 100);
        }
    }

    function updateNodeContent(shapeNode) {
        shapeNode.style({
            content: (e) => {
                return `ID: ${e.data("id")}\n Size: ${e.data("size")}`
            },
        });
    }

    function getColorBySize(size, color1 = COLOR_RANGE[0], color2 = COLOR_RANGE[1]) {
        var w1 = 1 - (size / 100.00);
        var w2 = size / 100.00;
        var rgb = `rgb(${Math.round(color1[0] * w1 + color2[0] * w2)},${Math.round(color1[1] * w1 + color2[1] * w2)},${Math.round(color1[2] * w1 + color2[2] * w2)})`;
        return rgb;

    }
    function changeCurrentShapeNode(shapeNode) {
        let shapeID = shapeNode.data('shapeID');
        shapeNode.style({
            'background-color': getColorBySize(shapeNode.data('size')),
            content: (e) => {
                return `ID: ${e.data("id")}\n Size: ${e.data("size")}`
            },
            "z-index": 2,
        });
    }

    function createNewShapeNode(shapeID, postionX = 0, positionY = 0) {
        cy.add({
            data: {
                id: 'node' + currentId,
                shapeID,
                size: NODESIZE,
                isSample: true
            },
            position: {
                x: postionX,
                y: NODESIZE + positionY,
            },
            style: {
                "background-color": 'black',
                shape: SHAPE_SET[shapeID],
                height: NODESIZE,
                width: NODESIZE,
                content: "Drag ME!",
            },
        });
        shapeIDList[shapeID] = currentId;
        currentId++;
    }

    function initCytoscape() {
        cy = cytoscape({
            container: document.getElementById('cy'), // container to render in
            elements: [],

            style: [ // the stylesheet for the graph
                {
                    selector: 'node[id]',
                    style: {
                        'font-size': '12px',
                        'text-wrap': 'wrap',
                        'line-height': 1.5,
                        /*
                            Using template strings for multiple data values in content text
                        */

                        // content: (e) => {
                        //     return `ID: ${e.data("id")}\n Size: ${e.data("size")}`
                        // }
                    }
                },

                {
                    selector: 'edge',
                    style: {
                        'width': 3,
                        'line-color': '#ccc',
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier'
                    }
                },
                // some style for the extension

                {
                    selector: '.eh-handle',
                    style: {
                        'background-color': 'red',
                        'width': 15,
                        'height': 15,
                        'shape': 'ellipse',
                        'overlay-opacity': 0,
                        'border-width': 15, // makes the handle easier to hit
                        'border-opacity': 0
                    }
                },

                {
                    selector: '.eh-hover',
                    style: {
                        'background-color': 'red'
                    }
                },

                {
                    selector: '.eh-source',
                    style: {
                        'border-width': 2,
                        'border-color': 'red'
                    }
                },

                {
                    selector: '.eh-target',
                    style: {
                        'border-width': 2,
                        'border-color': 'red'
                    }
                },

                {
                    selector: '.eh-preview, .eh-ghost-edge',
                    style: {
                        'background-color': 'red',
                        'line-color': 'red',
                        'target-arrow-color': 'red',
                        'source-arrow-color': 'red'
                    }
                },

                {
                    selector: '.eh-ghost-edge.eh-preview-active',
                    style: {
                        'opacity': 0
                    }
                }
            ],

            layout: {
                name: 'grid',
                rows: 1
            },

            pan: {
                x: 100,
                y: 0
            },
            userPanningEnabled: false,
        });

        ele = cytoscape()
        collection = cy.collection();
        cy.nodes().on('click', function (e) {
            var clickedNode = e.target;
            collection = collection.union(clickedNode);
        });

        // doShowSameGroupEles();

    }

    function doShowSameGroupEles() {
        cy.on('mouseover', 'node', function (evt) {
            let targetEle = cy.$("#" + evt.target.id());

            let eles = getGroupEles(targetEle);
            setColorforEles(eles, '#ff8c00');
        });

        cy.on('mouseout', 'node', function (evt) {
            let targetEle = cy.$("#" + evt.target.id());
            let eles = getGroupEles(targetEle);
            let color = getColorBySize(targetEle.data('size'))
            setColorforEles(eles, color);
        });
    }

    function getGroupEles(targetEle) {
        return cy.nodes().filter((ele) => {
            return ele.data('shapeID') == targetEle.data('shapeID');
        });
    }

    function setColorforEles(eles, color) {
        eles.forEach((ele, i, eles) => {
            ele.animate({
                style: {
                    backgroundColor: color
                },
                duration: 500
            });
        })
    }

    function updateCenterNode(e) {
        let nodeId = e.target.value;
        cy.center(cy.$('#node' + nodeId));
    }

    function handleFit() {
        cy.fit();
    }

    function changeNodeSize(e) {
        let size = e.target.value;
        if (size > 100) size = 100;
        currNode.data('size', size);
        updateNodeContent(currNode);
        currNode.style({
            height: size,
            width: size,
            backgroundColor: getColorBySize(size)
        });
    }

    function stopTextColor() {
        clearInterval(nIntervId);
    }

    function getRandomClass() {
        return Math.floor(Math.random() * 4);
    }

    function changecontentContent(shapeNode, { x, y }) {
        currNode = shapeNode;
        log("currNode", currNode.id())
        displayNodeInput(x, y);

    };

    function displayNodeInput(positionX, positionY) {
        let nodeInput = document.getElementById("nodeInput");
        nodeInput.value = "";
        nodeInput.type = "number";
        nodeInput.min = currNode.data('size')
        nodeInput.style.left = (positionX - NODESIZE / 2) + 'px';
        nodeInput.style.top = (100 + positionY - NODESIZE / 3) + 'px';
    }

    function hiddenNodeInput() {
        let nodeInput = document.getElementById("nodeInput");
        nodeInput.type = "hidden";
    }

    function createNodeInstance(id, size, shapeID, positionX, positionY, color = '', content = undefined) {
        cy.add({
            group: 'nodes',
            data: {
                id: 'node' + id,
                size,
                shapeID,
            },
            position: {
                x: positionX,
                y: positionY,
            },

            style: {
                "background-color": color ? color : getColorBySize(size),
                "z-index": 2,
                shape: SHAPE_SET[shapeID],
                height: size,
                width: size,
                content: (e) => {
                    return `ID: ${e.data("id")}\n Size: ${e.data("size")}`
                },
            },
        });
    }

    function createEdgeInstance(id, source, target) {
        cy.add({
            data: {
                id: 'edge' + id,
                source: source,
                target: target
            },
        });
    }

    function addNewNode() {
        let shapeID = getRandomClass();
        let size = 20 + Math.ceil(Math.random() * 4) * 10;
        // let size = 50;
        createNodeInstance(currentId, size, shapeID, Math.random() * WIDTH, Math.random() * HEIGHT);
        createEdgeInstance(currentId, 'node' + currentId, 'node' + Math.floor(Math.random() * currentId));
        currentId++;
    }

    function AddRandomNodeAndEdge(num) {
        if (typeof num != "number" || num <= 0) return;
        let i = 0;
        while (i < num) {
            addNewNode();
            i++;
        }
        cy.layout({ name: 'grid', padding: 50, }).run();

    }

    function cyMousedownEvent() {
        cy.on('mousedown', (evt) => {
            hiddenNodeInput();
        })
    }

    function cyMouseupEvent() {
        cy.on('mouseup', (evt) => {
            shapeIDList.forEach((shapeID, index) => {
                let shapeNode = cy.getElementById('node' + shapeID);
                if (shapeNode.grabbed()) {
                    changeCurrentShapeNode(shapeNode);
                    createNewShapeNode(index, NODESIZE / 2, index * 100);
                }
            })


        })
    }

    function cyMouseDoubleClick() {
        cy.on('tap', 'node', function (evt) {
            let node = evt.target;
            const { x, y } = node.renderedPosition();
            if (node.selected()) {
                changecontentContent(node, { x, y });
            }
        });
    }

    function initEdgeHandles() {
        var eh = cy.edgehandles({
            handleNodes: 'node',
            noEdgeEventsInDraw: true,
            snap: true
        });
        cy.on("ehshow", (event, sourceNode) => {
            if (sourceNode.data("isSample")) {
                log("Fired");
            }
        })
    }

    function main() {
        initCytoscape();
        initEdgeHandles();

        AddRandomNodeAndEdge(10);
        initExampleNode();

        // document.getElementById("center_node").addEventListener("change", updateCenterNode);
        // document.getElementById("button_fit").addEventListener("click", handleFit);
        document.getElementById("nodeInput").addEventListener("change", changeNodeSize);
        let linearGradient = 'linear-gradient( to right, rgb(' + COLOR_RANGE[0].join() + "), rgb(" + COLOR_RANGE[1].join() + ") 100%)";
        log(linearGradient);
        document.getElementsByClassName("gradient_color")[0].style.background = linearGradient;
        cyMousedownEvent();
        cyMouseupEvent();
        cyMouseDoubleClick();
        cy.fit();

        log(getColorBySize(0));
        log(getColorBySize(50));
        log(getColorBySize(100));

    }


    main();
</script>

</html>