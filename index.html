<!doctype html>

<html>

<head>
    <title>Tutorial 1: Getting Started</title>
    <!-- <script src="cytoscape.js" /> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.0/cytoscape.min.js"
        integrity="sha512-TOWs340KHbJjY/a2SCtsUcXYBg7/xPX72NKpJ3VITogkHJTy2yMyoJE0pxJjumMGHCg46ud89KO5q1Toe3Aeaw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.11/dist/interact.min.js"></script>
    <link rel="stylesheet" href="index.css" />
</head>

<body>
    <div id="cy"></div>
    <!-- <div class="controlContainer">
        <input type="text" name="center" id="center_node" placeholder="Please enter the node you want to CENTER">
        <button id="button_fit">Fit</button>
    </div> -->
</body>
<script type="text/javascript">
    var cy, nIntervId, eles, currentId = 0;
    var shapeIDList = [0, 0, 0, 0];

    const WIDTH = window.innerWidth, HEIGHT = window.innerHeight;
    const COLOR_PALETTES = ["#d5f4e6", "#80ced6", "#fefbd8", "#618685"];
    const SHAPE_SET = ['diamond', 'triangle', 'rectangle', 'hexagon']
    const { log } = console;
    var collection;

    function initExampleNode() {
        for (let i = 0; i < 4; i++) {
            createNewShapeNode(i, 0, i * 100);
        }
    }

    function changeCurrentShapeNode(shapeNode) {
        let shapeID = shapeNode.data('shapeID');
        log('shapeIDshapeIDshapeIDshapeID:', shapeID)
        shapeNode.style({
            'background-color': COLOR_PALETTES[shapeID],
            label: 'node' + shapeNode.id(),
            "z-index": 2,
        });
    }

    function createNewShapeNode(shapeID, postionX = 0, positionY = 0) {
        let size = 50;
        cy.add({
            data: {
                id: currentId,
                shapeID
            },
            position: {
                x: postionX,
                y: size + positionY,
            },
            style: {
                "background-color": 'black',
                shape: SHAPE_SET[shapeID],
                height: size,
                width: size,
                label: "Drag ME!",
            },
        });
        shapeIDList[shapeID] = currentId;
        currentId++;
    }

    function initCytoscape() {
        cy = cytoscape({
            container: document.getElementById('cy'), // container to render in
            elements: [],

            style: [ // the stylesheet for the graph
                {
                    selector: 'node',
                    style: {
                        label: 'data(id)'
                    }
                },

                {
                    selector: 'edge',
                    style: {
                        'width': 3,
                        'line-color': '#ccc',
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier'
                    }
                }
            ],

            layout: {
                name: 'grid',
                rows: 1
            },

            pan: {
                x: 100,
                y: 0
            },
            userPanningEnabled: false,
        });

        ele = cytoscape()
        collection = cy.collection();
        cy.nodes().on('click', function (e) {
            var clickedNode = e.target;
            collection = collection.union(clickedNode);
        });

        // doShowSameGroupEles();

    }

    function doShowSameGroupEles() {
        cy.on('mouseover', 'node', function (evt) {
            let targetEle = cy.$("#" + evt.target.id());

            let eles = getGroupEles(targetEle);
            setColorforEles(eles, '#ff8c00');
        });

        cy.on('mouseout', 'node', function (evt) {
            let targetEle = cy.$("#" + evt.target.id());
            let eles = getGroupEles(targetEle);
            let color = COLOR_PALETTES[targetEle.data('shapeID')]
            setColorforEles(eles, color);
        });
    }

    function getGroupEles(targetEle) {
        return cy.nodes().filter((ele) => {
            return ele.data('shapeID') == targetEle.data('shapeID');
        });
    }

    function setColorforEles(eles, color) {
        eles.forEach((ele, i, eles) => {
            ele.animate({
                style: {
                    backgroundColor: color
                },
                duration: 500
            });
        })
    }

    function updateCenterNode(e) {
        let nodeId = e.target.value;
        cy.center(cy.$('#node' + nodeId));
    }

    function handleFit() {
        cy.fit();
    }

    function stopTextColor() {
        clearInterval(nIntervId);
    }

    function getRandomClass() {
        return Math.floor(Math.random() * 4);
    }

    function createNodeInstance(id, weight, shapeID, positionX, postionY, color = '', label = undefined) {
        cy.add({
            data: {
                id: 'node' + id,
                weight,
                shapeID,
            },
            position: {
                x: positionX,
                y: postionY,
            },
            style: {
                "background-color": color ? color : COLOR_PALETTES[shapeID],
                "z-index": 2,
                shape: SHAPE_SET[shapeID],
                height: weight,
                width: weight,
                label
            },
        });
    }
    function createEdgeInstance(id, source, target) {
        cy.add({
            data: {
                id: 'edge' + id,
                source: source,
                target: target
            },
        });
    }
    function addNewNode() {
        let shapeID = getRandomClass();
        // let weight = 20 + Math.ceil(Math.random() * 4) * 5;
        let weight = 50;
        createNodeInstance(currentId, weight, shapeID, Math.random() * WIDTH, Math.random() * HEIGHT);
        createEdgeInstance(currentId, 'node' + currentId, 'node' + Math.floor(Math.random() * currentId));
        currentId++;
    }

    function AddRandomNodeAndEdge(num) {
        if (typeof num != "number" || num <= 0) return;
        let i = 0;
        while (i < num) {
            addNewNode();
            i++;
        }
        cy.layout({ name: 'circle', padding: 50, }).run();

    }

    function cyMousedownEvent() {
        cy.on('mousedown', (evt) => {


        })
    }

    function cyMouseupEvent() {
        cy.on('mouseup', (evt) => {
            log('=====shapeIDList:', shapeIDList);

            shapeIDList.forEach((shapeID, index) => {
                let shapeNode = cy.getElementById(shapeID);
                if (shapeNode.grabbed()) {
                    changeCurrentShapeNode(shapeNode);
                    createNewShapeNode(index, 0, index * 100);
                }
            })


        })
    }

    function main() {
        initCytoscape();
        AddRandomNodeAndEdge(10);
        initExampleNode();

        // document.getElementById("center_node").addEventListener("change", updateCenterNode);
        // document.getElementById("button_fit").addEventListener("click", handleFit);
        cyMousedownEvent();
        cyMouseupEvent();
    }


    main();
</script>

</html>